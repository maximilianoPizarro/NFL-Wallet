# Build NFL-Wallet images and push to quay.io (same logic as build-push-quay.sh)
# Requires GitHub secrets:
#   QUAY_USERNAME, QUAY_PASSWORD (Quay robot account)
#   REDHAT_REGISTRY_USERNAME, REDHAT_REGISTRY_PASSWORD (Red Hat registry for UBI base images)
# Optional: QUAY_NAMESPACE (default: maximilianopizarro)

name: Build and push to Quay.io

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  QUAY_REGISTRY: quay.io
  QUAY_NAMESPACE: maximilianopizarro  # override via repository variable QUAY_NAMESPACE if needed

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          missing=""
          [ -z "$QUAY_USERNAME" ] && missing="$missing QUAY_USERNAME"
          [ -z "$QUAY_PASSWORD" ] && missing="$missing QUAY_PASSWORD"
          [ -z "$REDHAT_REGISTRY_USERNAME" ] && missing="$missing REDHAT_REGISTRY_USERNAME"
          [ -z "$REDHAT_REGISTRY_PASSWORD" ] && missing="$missing REDHAT_REGISTRY_PASSWORD"
          if [ -n "$missing" ]; then
            echo "::error::Missing or empty GitHub Actions secrets:$missing"
            echo "Add them in: Repository Settings → Secrets and variables → Actions → New repository secret"
            echo "Required secrets (exact names): QUAY_USERNAME, QUAY_PASSWORD, REDHAT_REGISTRY_USERNAME, REDHAT_REGISTRY_PASSWORD"
            exit 1
          fi
          echo "All required secrets are set."
        env:
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
          REDHAT_REGISTRY_USERNAME: ${{ secrets.REDHAT_REGISTRY_USERNAME }}
          REDHAT_REGISTRY_PASSWORD: ${{ secrets.REDHAT_REGISTRY_PASSWORD }}

      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Log in to Red Hat registry (registry.access.redhat.com)
        uses: docker/login-action@v3
        with:
          registry: registry.access.redhat.com
          username: ${{ secrets.REDHAT_REGISTRY_USERNAME }}
          password: ${{ secrets.REDHAT_REGISTRY_PASSWORD }}

      - name: Log in to Red Hat registry (registry.redhat.io)
        uses: docker/login-action@v3
        with:
          registry: registry.redhat.io
          username: ${{ secrets.REDHAT_REGISTRY_USERNAME }}
          password: ${{ secrets.REDHAT_REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use host Docker so registry logins (Quay, Red Hat) are available when pulling base images
          driver: docker

      - name: Build and push nfl-wallet-api-customers
        uses: docker/build-push-action@v6
        with:
          context: ./ApiCustomers
          file: ./ApiCustomers/Containerfile
          push: true
          tags: |
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-wallet-api-customers:latest
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-wallet-api-customers:${{ github.sha }}

      - name: Build and push nfl-api-bills
        uses: docker/build-push-action@v6
        with:
          context: ./ApiWalletBuffaloBills
          file: ./ApiWalletBuffaloBills/Containerfile
          push: true
          tags: |
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-api-bills:latest
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-api-bills:${{ github.sha }}

      - name: Build and push nfl-wallet-api-raiders
        uses: docker/build-push-action@v6
        with:
          context: ./ApiWalletLasVegasRaiders
          file: ./ApiWalletLasVegasRaiders/Containerfile
          push: true
          tags: |
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-wallet-api-raiders:latest
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-wallet-api-raiders:${{ github.sha }}

      - name: Build and push nfl-wallet-webapp
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Containerfile
          push: true
          tags: |
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-wallet-webapp:latest
            ${{ env.QUAY_REGISTRY }}/${{ env.QUAY_NAMESPACE }}/nfl-wallet-webapp:${{ github.sha }}
