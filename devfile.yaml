# NFL Stadium Wallet - Red Hat OpenShift Dev Spaces
# Two components: apis (UBI + .NET 8) and webapp (Node 20). Two steps: build, run.
schemaVersion: 2.2.2
metadata:
  name: nfl-wallet
  displayName: NFL Stadium Wallet
  description: |
    Full-stack: Vue 3 + Vite frontend and three .NET 8.0 APIs.
    Step 1: build (frontend + APIs). Step 2: run (APIs in background + frontend).
  icon: https://raw.githubusercontent.com/dotnet/brand/main/logo/dotnet-logo.png
  tags:
    - Vue
    - .NET 8.0
    - NFL
  projectType: fullstack
  language: javascript
  version: 1.0.0

components:
  - name: apis
    container:
      image: registry.access.redhat.com/ubi8/dotnet-80:latest
      args: ["tail", "-f", "/dev/null"]
      mountSources: true
      memoryLimit: 2Gi
      env:
        - name: CONFIGURATION
          value: Debug
        # Allow all origins so frontend (e.g. OpenShift webapp route) can call these APIs
        - name: CORS__AllowedOrigins
          value: "*"
      endpoints:
        - name: api-customers
          targetPort: 8080
          protocol: http
          exposure: public
          path: /api-customers
        - name: api-bills
          targetPort: 8081
          protocol: http
          exposure: public
          path: /api-bills
        - name: api-raiders
          targetPort: 8082
          protocol: http
          exposure: public
          path: /api-raiders

  - name: webapp
    container:
      image: registry.access.redhat.com/ubi8/nodejs-20:latest
      args: ["tail", "-f", "/dev/null"]
      mountSources: true
      memoryLimit: 1Gi
      env:
        # Relative paths: browser calls same origin, Vite proxies to apis component (DNS: apis)
        - name: VITE_API_CUSTOMERS_URL
          value: /api-customers
        - name: VITE_API_BILLS_URL
          value: /api-bills
        - name: VITE_API_RAIDERS_URL
          value: /api-raiders
        # In Dev Spaces, proxy API requests to the apis component (K8s service name)
        - name: PROXY_API_HOST
          value: apis
      endpoints:
        - name: webapp
          targetPort: 5173
          protocol: http

commands:
  # Step 1: build = frontend + APIs
  - id: build-frontend
    exec:
      component: webapp
      workingDir: ${PROJECT_SOURCE}/frontend
      commandLine: sh -c "npm install && (chmod -R +x node_modules/.bin 2>/dev/null || true) && npm run build"

  - id: build-apis
    exec:
      component: apis
      workingDir: ${PROJECT_SOURCE}
      commandLine: sh -c "dotnet build ApiCustomers/ApiCustomers.csproj -c Debug && dotnet build ApiWalletBuffaloBills/ApiWalletBuffaloBills.csproj -c Debug && dotnet build ApiWalletLasVegasRaiders/ApiWalletLasVegasRaiders.csproj -c Debug"

  - id: build
    composite:
      commands:
        - build-frontend
        - build-apis
      group:
        kind: build
        isDefault: true

  # Step 2: run = APIs (background) + frontend (foreground)
  - id: run-apis
    exec:
      component: apis
      workingDir: ${PROJECT_SOURCE}
      commandLine: sh -c "set -e && dotnet build ApiCustomers/ApiCustomers.csproj -c Debug --nologo -v q && dotnet build ApiWalletBuffaloBills/ApiWalletBuffaloBills.csproj -c Debug --nologo -v q && dotnet build ApiWalletLasVegasRaiders/ApiWalletLasVegasRaiders.csproj -c Debug --nologo -v q && ( dotnet run --project ApiCustomers/ApiCustomers.csproj -c Debug --no-build --urls http://*:8080 </dev/null >>/tmp/api-customers.log 2>&1 & ) && ( dotnet run --project ApiWalletBuffaloBills/ApiWalletBuffaloBills.csproj -c Debug --no-build --urls http://*:8081 </dev/null >>/tmp/api-bills.log 2>&1 & ) && ( dotnet run --project ApiWalletLasVegasRaiders/ApiWalletLasVegasRaiders.csproj -c Debug --no-build --urls http://*:8082 </dev/null >>/tmp/api-raiders.log 2>&1 & ) && sleep 3 && echo APIs started on 8080, 8081, 8082"

  - id: run-frontend
    exec:
      component: webapp
      workingDir: ${PROJECT_SOURCE}/frontend
      commandLine: sh -c "(chmod -R +x node_modules/.bin 2>/dev/null || true); npx vite"

  - id: run
    composite:
      commands:
        - run-apis
        - run-frontend
      group:
        kind: run
        isDefault: true
