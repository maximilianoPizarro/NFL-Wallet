schemaVersion: 2.2.2
metadata:
  name: nfl-wallet
  displayName: NFL Wallet - .NET 8.0
  description: .NET 8.0 solution with ApiCustomers, Buffalo Bills & Las Vegas Raiders wallets, and WebApp
  icon: https://raw.githubusercontent.com/dotnet/brand/main/logo/dotnet-logo.png
  tags:
    - .NET
    - .NET 8.0
  projectType: dotnet
  language: .NET
  version: 1.0.0

components:
  - name: webapp
    container:
      image: registry.access.redhat.com/ubi8/dotnet-80:8.0-13
      args: ["tail", "-f", "/dev/null"]
      mountSources: true
      env:
        - name: CONFIGURATION
          value: Debug
        - name: STARTUP_PROJECT
          value: WebApp/WebApp.csproj
        - name: ASPNETCORE_ENVIRONMENT
          value: Development
        - name: ASPNETCORE_URLS
          value: http://*:8083
        - name: Api__CustomersBaseUrl
          value: http://localhost:8080/api
        - name: Api__BuffaloBillsBaseUrl
          value: http://localhost:8081/api
        - name: Api__LasVegasRaidersBaseUrl
          value: http://localhost:8082/api
      endpoints:
        - name: webapp
          targetPort: 8083
          protocol: http
        - name: customers
          targetPort: 8080
          protocol: http
        - name: bills
          targetPort: 8081
          protocol: http
        - name: raiders
          targetPort: 8082
          protocol: http

commands:
  - id: build
    exec:
      component: webapp
      workingDir: ${PROJECT_SOURCE}
      commandLine: >
        dotnet build ApiCustomers/ApiCustomers.csproj -c $CONFIGURATION /p:UseSharedCompilation=false &&
        dotnet build ApiWalletBuffaloBills/ApiWalletBuffaloBills.csproj -c $CONFIGURATION /p:UseSharedCompilation=false &&
        dotnet build ApiWalletLasVegasRaiders/ApiWalletLasVegasRaiders.csproj -c $CONFIGURATION /p:UseSharedCompilation=false &&
        dotnet build WebApp/WebApp.csproj -c $CONFIGURATION /p:UseSharedCompilation=false

  - id: run
    exec:
      component: webapp
      workingDir: ${PROJECT_SOURCE}
      commandLine: >
        ASPNETCORE_URLS=http://*:8080 dotnet ApiCustomers/bin/Debug/net8.0/ApiCustomers.dll &
        ASPNETCORE_URLS=http://*:8081 dotnet ApiWalletBuffaloBills/bin/Debug/net8.0/ApiWalletBuffaloBills.dll &
        ASPNETCORE_URLS=http://*:8082 dotnet ApiWalletLasVegasRaiders/bin/Debug/net8.0/ApiWalletLasVegasRaiders.dll &
        Api__CustomersBaseUrl=http://localhost:8080/api Api__BuffaloBillsBaseUrl=http://localhost:8081/api Api__LasVegasRaidersBaseUrl=http://localhost:8082/api ASPNETCORE_URLS=http://*:8083 dotnet WebApp/bin/Debug/net8.0/WebApp.dll &
        wait
