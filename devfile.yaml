# NFL Stadium Wallet - Red Hat OpenShift Dev Spaces
# Two components: apis (UBI + .NET 8) and webapp (Node 20). Two steps: build, run.
schemaVersion: 2.2.2
metadata:
  name: nfl-wallet
  displayName: NFL Stadium Wallet
  description: |
    Full-stack: Vue 3 + Vite frontend and three .NET 8.0 APIs.
    Step 1: build (frontend + APIs). Step 2: run (APIs in background + frontend).
  icon: https://raw.githubusercontent.com/dotnet/brand/main/logo/dotnet-logo.png
  tags:
    - Vue
    - .NET 8.0
    - NFL
  projectType: fullstack
  language: javascript
  version: 1.0.0

components:
  - name: apis
    container:
      image: registry.access.redhat.com/ubi8/dotnet-80:latest
      args: ["tail", "-f", "/dev/null"]
      mountSources: true
      memoryLimit: 2Gi
      env:
        - name: CONFIGURATION
          value: Debug
        # Allow all origins so frontend (e.g. OpenShift webapp route) can call these APIs
        - name: CORS__AllowedOrigins
          value: "*"
      # No path: APIs serve at /api (e.g. /api/Customers, /api/Wallet/...). Public URLs are .../api/Customers, .../api/Wallet/...
      endpoints:
        - name: api-customers
          targetPort: 8080
          protocol: http
          exposure: public
        - name: api-bills
          targetPort: 8081
          protocol: http
          exposure: public
        - name: api-raiders
          targetPort: 8082
          protocol: http
          exposure: public

  - name: webapp
    container:
      image: registry.access.redhat.com/ubi8/nodejs-20:latest
      args: ["tail", "-f", "/dev/null"]
      mountSources: true
      memoryLimit: 1Gi
      env:
        # Public API URLs (browser calls these directly; no proxy). Replace with your cluster URLs if different.
        - name: API_CUSTOMERS_URL
          value: http://kube-admin-nfl-wallet-api-customers.apps.cluster-zrg7z.zrg7z.sandbox489.opentlc.com/api
        - name: API_BILLS_URL
          value: http://kube-admin-nfl-wallet-api-bills.apps.cluster-zrg7z.zrg7z.sandbox489.opentlc.com/api
        - name: API_RAIDERS_URL
          value: http://kube-admin-nfl-wallet-api-raiders.apps.cluster-zrg7z.zrg7z.sandbox489.opentlc.com/api
      endpoints:
        - name: webapp
          targetPort: 5173
          protocol: http

commands:
  # Step 1: build = frontend + APIs
  - id: build-frontend
    exec:
      component: webapp
      workingDir: ${PROJECT_SOURCE}/frontend
      commandLine: sh -c "npm install && (chmod -R +x node_modules/.bin 2>/dev/null || true) && npm run build"

  - id: build-apis
    exec:
      component: apis
      workingDir: ${PROJECT_SOURCE}
      commandLine: sh -c "dotnet build ApiCustomers/ApiCustomers.csproj -c Debug && dotnet build ApiWalletBuffaloBills/ApiWalletBuffaloBills.csproj -c Debug && dotnet build ApiWalletLasVegasRaiders/ApiWalletLasVegasRaiders.csproj -c Debug"

  - id: build
    composite:
      commands:
        - build-frontend
        - build-apis
      group:
        kind: build
        isDefault: true

  # Step 2: run = APIs (background) + frontend (foreground)
  - id: run-apis
    exec:
      component: apis
      workingDir: ${PROJECT_SOURCE}
      # bash + disown so APIs keep running after this command exits (DevWorkspace may kill children of sh)
      commandLine: bash -c "dotnet build ApiCustomers/ApiCustomers.csproj -c Debug --nologo -v q && dotnet build ApiWalletBuffaloBills/ApiWalletBuffaloBills.csproj -c Debug --nologo -v q && dotnet build ApiWalletLasVegasRaiders/ApiWalletLasVegasRaiders.csproj -c Debug --nologo -v q && ( nohup dotnet run --project ApiCustomers/ApiCustomers.csproj -c Debug --no-build --urls http://*:8080 >>/tmp/api-customers.log 2>&1 & nohup dotnet run --project ApiWalletBuffaloBills/ApiWalletBuffaloBills.csproj -c Debug --no-build --urls http://*:8081 >>/tmp/api-bills.log 2>&1 & nohup dotnet run --project ApiWalletLasVegasRaiders/ApiWalletLasVegasRaiders.csproj -c Debug --no-build --urls http://*:8082 >>/tmp/api-raiders.log 2>&1 & ); disown -a; sleep 4; echo APIs started on 8080, 8081, 8082"

  - id: run-frontend
    exec:
      component: webapp
      workingDir: ${PROJECT_SOURCE}/frontend
      # Write config.json from env so the app calls public API URLs (no proxy, no ENOTFOUND)
      commandLine: sh -c "node -e \"const c=process.env; require('fs').writeFileSync('public/config.json', JSON.stringify({apiCustomersUrl:c.API_CUSTOMERS_URL||'',apiBillsUrl:c.API_BILLS_URL||'',apiRaidersUrl:c.API_RAIDERS_URL||''}))\" && (chmod -R +x node_modules/.bin 2>/dev/null || true) && npx vite"

  - id: run
    composite:
      commands:
        - run-apis
        - run-frontend
      group:
        kind: run
        isDefault: true
